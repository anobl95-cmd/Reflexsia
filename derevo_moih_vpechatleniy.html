<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üå≥ –î–µ—Ä–µ–≤–æ –º–æ–∏—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π</title>
  <style>
    :root{
      --bg1:#f7fbff;
      --bg2:#fff6fb;
      --card:#ffffffcc;
      --text:#0f172a;
      --muted:#475569;
      --shadow: 0 18px 40px rgba(15, 23, 42, .10);
      --radius: 22px;

      --canopy: 520px;
      --trunk-w: 70px;
      --trunk-h: 200px;

      --btn-font: 1.55rem; /* >= 1.5rem */
      --h1-font: 2.6rem;   /* >= 2.4rem */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, #e8fff3 0%, rgba(232,255,243,0) 60%),
        radial-gradient(900px 600px at 85% 15%, #ffe8f2 0%, rgba(255,232,242,0) 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      display:flex;
      justify-content:center;
      padding:28px 16px 44px;
    }

    .wrap{
      width:min(1180px, 100%);
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    header{
      text-align:center;
      padding:18px 16px 10px;
    }
    h1{
      margin:0;
      font-size:var(--h1-font);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:10px auto 0;
      max-width: 62ch;
      font-size:1.15rem;
      color:var(--muted);
      line-height:1.35;
    }

    .layout{
      display:flex;
      gap:18px;
      align-items:stretch;
    }

    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border:1px solid rgba(148, 163, 184, .35);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    /* LEFT: tree */
    .tree-card{
      flex: 1 1 62%;
      padding:18px;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height: 640px;
    }

    .tree-stage{
      position:relative;
      width: var(--canopy);
      height: calc(var(--canopy) + var(--trunk-h) + 32px);
      display:flex;
      justify-content:center;
      align-items:flex-end;
    }

    .canopy{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(var(--trunk-h) + 22px); /* –ù–ï –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–≤–æ–ª */
      width: var(--canopy);
      height: var(--canopy);
      border-radius: 50%;
      background: radial-gradient(circle at 35% 30%, #8fd6a0 0%, #6bbf8b 55%, #53a775 100%);
      box-shadow:
        inset 0 12px 30px rgba(255,255,255,.45),
        0 22px 40px rgba(16,185,129,.18);
      overflow:hidden;
    }

    .canopy::after{
      /* –ª–µ–≥–∫–∞—è —Ç–µ–∫—Å—Ç—É—Ä–∞ */
      content:"";
      position:absolute;
      inset:-25%;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.35) 0 8%, rgba(255,255,255,0) 9% 100%),
        radial-gradient(circle at 65% 35%, rgba(255,255,255,.22) 0 10%, rgba(255,255,255,0) 11% 100%),
        radial-gradient(circle at 40% 70%, rgba(0,0,0,.05) 0 12%, rgba(0,0,0,0) 13% 100%);
      filter: blur(0.2px);
      pointer-events:none;
      opacity:.7;
    }

    .trunk{
      position:absolute;
      bottom: 10px;
      left:50%;
      transform:translateX(-50%);
      width: var(--trunk-w);
      height: var(--trunk-h);
      border-radius: 18px;
      background: linear-gradient(180deg, #3E2723 0%, #5D4037 100%);
      box-shadow:
        inset 0 10px 18px rgba(255,255,255,.14),
        0 18px 30px rgba(62,39,35,.25);
    }

    .trunk::before, .trunk::after{
      content:"";
      position:absolute;
      bottom:-10px;
      width: 44px;
      height: 26px;
      border-radius: 20px;
      background: linear-gradient(180deg, #3E2723 0%, #5D4037 100%);
      opacity:.95;
    }
    .trunk::before{ left:-26px; transform: rotate(-6deg); }
    .trunk::after{ right:-26px; transform: rotate(6deg); }

    .token{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(.6);
      font-size: 3.4rem;
      filter: drop-shadow(0 10px 16px rgba(2, 6, 23, .12));
      cursor:pointer;
      user-select:none;
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .token.is-in{
      opacity:1;
      transform: translate(-50%,-50%) scale(1);
      animation: pop .28s ease-out;
    }
    @keyframes pop{
      0%{ transform: translate(-50%,-50%) scale(.35); opacity:0; }
      70%{ transform: translate(-50%,-50%) scale(1.08); opacity:1; }
      100%{ transform: translate(-50%,-50%) scale(1); }
    }

    /* RIGHT: control panel */
    .panel{
      flex: 1 1 38%;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width: 320px;
    }

    .btn{
      position:relative;
      display:flex;
      gap:12px;
      align-items:center;
      width:100%;
      padding:16px 16px 16px 18px;
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 18px;
      background:#fff;
      box-shadow: 0 14px 28px rgba(15,23,42,.08);
      font-size: var(--btn-font);
      font-weight: 700;
      color: var(--text);
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
      text-align:left;
    }
    .btn:active{ transform: translateY(1px); box-shadow: 0 10px 20px rgba(15,23,42,.08); }
    .btn::before{
      content:"";
      position:absolute;
      left:0;
      top:12px;
      bottom:12px;
      width:10px;
      border-radius: 999px;
      background: #22c55e;
    }
    .btn .emoji{ font-size: 2rem; }

    .btn.leaf::before{ background:#22c55e; }
    .btn.flower::before{ background:#fb7185; }
    .btn.fruit::before{ background:#fb923c; }

    .stats{
      margin-top:auto;
      padding:14px;
      border-radius: 18px;
      background: rgba(255,255,255,.75);
      border:1px dashed rgba(148,163,184,.55);
    }
    .stats h2{
      margin:0 0 10px;
      font-size:1.2rem;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.2px;
    }
    .stat-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .stat{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      background:#fff;
      border:1px solid rgba(148,163,184,.28);
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      font-size:1.15rem;
      font-weight: 700;
    }
    .stat .left{ display:flex; gap:10px; align-items:center; }
    .stat .left span{ font-size: 1.6rem; }
    .stat .num{
      font-variant-numeric: tabular-nums;
      font-size:1.25rem;
    }

    .hint{
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 1.0rem;
      line-height: 1.35;
    }

    /* Responsive */
    @media (max-width: 980px){
      :root{ --canopy: min(520px, 88vw); }
      .layout{ flex-direction:column; }
      .panel{ min-width: unset; }
      .tree-card{ min-height: 620px; }
      header{ padding-bottom: 2px; }
    }

    @media (max-width: 420px){
      :root{
        --btn-font: 1.5rem;
        --h1-font: 2.45rem;
      }
      .btn{ padding: 15px; }
      .token{ font-size: 3.2rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üå≥ –î–µ—Ä–µ–≤–æ –º–æ–∏—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π</h1>
      <p class="subtitle">–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –ª–∏—Å—Ç, —Ü–≤–µ—Ç–æ–∫ –∏–ª–∏ –ø–ª–æ–¥ –Ω–∞ –¥–µ—Ä–µ–≤–æ</p>
    </header>

    <main class="layout">
      <section class="card tree-card" aria-label="–î–µ—Ä–µ–≤–æ">
        <div class="tree-stage">
          <div id="canopy" class="canopy" aria-label="–ö—Ä–æ–Ω–∞ –¥–µ—Ä–µ–≤–∞ (—Å—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —ç–ª–µ–º–µ–Ω—Ç—ã)"></div>
          <div class="trunk" aria-hidden="true"></div>
        </div>
      </section>

      <aside class="card panel" aria-label="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">
        <button class="btn leaf" id="btnLeaf" type="button">
          <span class="emoji" aria-hidden="true">üçÉ</span>
          <span>–Ø —É–∑–Ω–∞–ª —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ</span>
        </button>

        <button class="btn flower" id="btnFlower" type="button">
          <span class="emoji" aria-hidden="true">üå∏</span>
          <span>–ú–Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å</span>
        </button>

        <button class="btn fruit" id="btnFruit" type="button">
          <span class="emoji" aria-hidden="true">üçé</span>
          <span>–Ø —ç—Ç–∏–º –≤–æ—Å–ø–æ–ª—å–∑—É—é—Å—å –≤ –∂–∏–∑–Ω–∏</span>
        </button>

        <p class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–∂–º–∏ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –≤ –∫—Ä–æ–Ω–µ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –µ–≥–æ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º).</p>

        <div class="stats" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
          <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
          <div class="stat-grid">
            <div class="stat">
              <div class="left"><span aria-hidden="true">üçÉ</span><div>–õ–∏—Å—Ç—å—è</div></div>
              <div class="num" id="countLeaf">0</div>
            </div>
            <div class="stat">
              <div class="left"><span aria-hidden="true">üå∏</span><div>–¶–≤–µ—Ç—ã</div></div>
              <div class="num" id="countFlower">0</div>
            </div>
            <div class="stat">
              <div class="left"><span aria-hidden="true">üçé</span><div>–ü–ª–æ–¥—ã</div></div>
              <div class="num" id="countFruit">0</div>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    (function(){
      const canopy = document.getElementById('canopy');

      const countLeaf = document.getElementById('countLeaf');
      const countFlower = document.getElementById('countFlower');
      const countFruit = document.getElementById('countFruit');

      const btnLeaf = document.getElementById('btnLeaf');
      const btnFlower = document.getElementById('btnFlower');
      const btnFruit = document.getElementById('btnFruit');

      const EMOJI = { leaf: "üçÉ", flower: "üå∏", fruit: "üçé" };
      const STORAGE_KEY = "reflection_tree_tokens_v1";

      /** items: { id, type, rNorm, theta } */
      let items = [];

      function uid(){
        return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
      }

      function getRadius(){
        const rect = canopy.getBoundingClientRect();
        // –ß—Ç–æ–±—ã —ç–º–æ–¥–∑–∏ –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∏—Å—å –ø–æ –∫—Ä–∞—è–º:
        const padding = 34; // px
        return Math.max(10, rect.width / 2 - padding);
      }

      function polarToXY(rNorm, theta){
        const R = getRadius();
        const cx = canopy.clientWidth / 2;
        const cy = canopy.clientHeight / 2;
        const r = rNorm * R;
        return {
          x: cx + r * Math.cos(theta),
          y: cy + r * Math.sin(theta)
        };
      }

      function save(){
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        }catch(e){ /* ignore */ }
      }

      function load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return;
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)) items = parsed.filter(x => x && x.id && x.type && typeof x.rNorm === "number" && typeof x.theta === "number");
        }catch(e){
          items = [];
        }
      }

      function clearCanopy(){
        canopy.querySelectorAll('.token').forEach(el => el.remove());
      }

      function updateCounters(){
        let a=0,b=0,c=0;
        for(const it of items){
          if(it.type === "leaf") a++;
          else if(it.type === "flower") b++;
          else if(it.type === "fruit") c++;
        }
        countLeaf.textContent = a;
        countFlower.textContent = b;
        countFruit.textContent = c;
      }

      function createTokenElement(item){
        const el = document.createElement('span');
        el.className = 'token';
        el.textContent = EMOJI[item.type] || "‚Ä¢";
        el.setAttribute('role', 'button');
        el.setAttribute('tabindex', '0');
        el.setAttribute('aria-label', '–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç');

        function removeWithConfirm(){
          const ok = confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç —Å –¥–µ—Ä–µ–≤–∞?");
          if(!ok) return;
          items = items.filter(x => x.id !== item.id);
          el.remove();
          updateCounters();
          save();
        }

        el.addEventListener('click', removeWithConfirm);
        el.addEventListener('keydown', (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            removeWithConfirm();
          }
        });

        canopy.appendChild(el);
        positionTokenElement(el, item);

        // trigger animation
        requestAnimationFrame(() => el.classList.add('is-in'));
      }

      function positionTokenElement(el, item){
        const {x,y} = polarToXY(item.rNorm, item.theta);
        el.style.left = x + "px";
        el.style.top  = y + "px";
      }

      function renderAll(){
        clearCanopy();
        for(const item of items){
          createTokenElement(item);
        }
        updateCounters();
      }

      function addItem(type){
        // —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –ø–ª–æ—â–∞–¥–∏: rNorm = sqrt(rand)
        const rNorm = Math.sqrt(Math.random());
        const theta = Math.random() * Math.PI * 2;

        const item = { id: uid(), type, rNorm, theta };
        items.push(item);
        createTokenElement(item);
        updateCounters();
        save();
      }

      function reflowPositions(){
        const els = canopy.querySelectorAll('.token');
        // —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –ø–æ—Ä—è–¥–∫—É (–ø–æ—Å–ª–µ renderAll —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
        for(let i=0; i<els.length; i++){
          const item = items[i];
          if(!item) continue;
          positionTokenElement(els[i], item);
        }
      }

      btnLeaf.addEventListener('click', () => addItem('leaf'));
      btnFlower.addEventListener('click', () => addItem('flower'));
      btnFruit.addEventListener('click', () => addItem('fruit'));

      // init
      load();
      renderAll();

      // keep positions correct on resize (–º–æ–±–∏–ª–∫–∏/–ø–æ–≤–æ—Ä–æ—Ç)
      let resizeTimer = null;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(reflowPositions, 80);
      });
    })();
  </script>
</body>
</html>
